# DNS Audit Report

**Date:** 2026-02-04
**Source of truth:** Cloudflare API + kubectl (live cluster)
**Zones audited:** 10

## Summary

| Zone | Total records | Ownership records | Management ratio |
|------|--------------|-------------------|------------------|
| better-skill-capped.com | 4 | 0 | **0% managed** |
| clauderon.com | 6 | 2 | 33% managed |
| discord-plays-pokemon.com | 6 | 2 | 33% managed |
| glitter-boys.com | 6 | 0 | **0% managed** |
| jerred.is | 7 | 2 | 29% managed |
| jerredshepherd.com | 5 | 0 | **0% managed** |
| scout-for-lol.com | 6 | 2 | 33% managed |
| shepherdjerred.com | 21 | 1 | **5% managed** |
| sjer.red | 80 | 25 | 31% managed |
| ts-mc.net | 20 | 5 | 25% managed |

"Ownership records" = `_externaldns.*` or `_managed.*` TXT records proving
external-dns or the tunnel operator actually controls the record.

---

## Critical Issues

### 1. CNAME/TXT apex conflict silently dropping records

external-dns logs every 60s:
```
Domain rp.sjer.red. contains conflicting record type candidates; discarding CNAME record
Domain shepherdjerred.com. contains conflicting record type candidates; discarding CNAME record
Domain jerredshepherd.com. contains conflicting record type candidates; discarding CNAME record
```

**Root cause:** DNSEndpoints define both a CNAME and other record types (TXT, MX) at the
same name. Per RFC 1912, CNAME cannot coexist with other types. external-dns detects
this and silently discards the CNAME every sync cycle.

**Affected records:**

| Domain | CNAME target | Conflicting types | Consequence |
|--------|-------------|-------------------|-------------|
| `rp.sjer.red` | ddns.sjer.red | TXT (SPF) + MX | **CNAME never created.** Record missing from CF entirely. |
| `shepherdjerred.com` | sjer.red | TXT (SPF) + MX | CNAME exists (manual) but external-dns can't adopt it. |
| `jerredshepherd.com` | sjer.red | TXT (SPF) | CNAME exists (manual) but external-dns can't adopt it. |

**Impact:** The `rp.sjer.red` CNAME (Postal return-path) does not exist in Cloudflare.
This may affect Postal's ability to receive bounce messages at rp.sjer.red if it
relies on that CNAME for resolution. However, the MX records for rp.sjer.red do exist
and point to FastMail, so email delivery likely still works.

### 2. Active drift: ts-mc.net DMARC policy

| | DMARC value |
|---|---|
| **k8s desired (in cluster):** | `v=DMARC1; p=quarantine; rua=mailto:dmarc@ts-mc.net` |
| **Cloudflare actual:** | `v=DMARC1; p=reject; sp=reject; adkim=s; aspf=s;` |

external-dns owns this record (`_externaldns.txt-_dmarc.ts-mc.net` exists) but has not
updated it to match the desired state. The k8s DNSEndpoint was likely changed recently
and external-dns hasn't reconciled, or there's a sync issue.

### 3. Three zones have zero external-dns ownership

Despite having DNSEndpoints deployed in the cluster, external-dns has **not taken ownership**
of any records in these zones:

- **better-skill-capped.com** (4 records, 0 ownership)
- **glitter-boys.com** (6 records, 0 ownership)
- **jerredshepherd.com** (5 records, 0 ownership)

This means if these records are manually deleted from Cloudflare, external-dns
will not recreate them. The DNSEndpoints are deployed but not effective.

---

## Stale Records in Cloudflare

Records that exist in Cloudflare with `_managed.*` ownership TXT but have no
corresponding TunnelBinding in the cluster:

| Record | Value |
|--------|-------|
| `CNAME` peertube.sjer.red | cfargotunnel (+ `_managed.peertube.sjer.red` TXT) |
| `CNAME` bugsink.shepherdjerred.com.sjer.red | cfargotunnel (+ `_managed.bugsink.shepherdjerred.com.sjer.red` TXT) |

These are orphaned tunnel records from deleted services. The tunnel operator should
have cleaned them up but didn't.

Additionally:

| Record | Notes |
|--------|-------|
| `TXT` postal-isna7c._domainkey.sjer.red | Old Postal DKIM key. Current key is `postal-aooLXx`. |
| `TXT` _externaldns.srv-_minecraft._tcp.ts-mc.net | Stale ownership TXT. No DNSEndpoint defines this SRV anymore. The actual SRV record still exists. |

---

## Complete Inventory of Unmanaged Records

### Per domain, records with NO `_externaldns.*` or `_managed.*` ownership:

#### sjer.red (20 unmanaged records)

| Type | Name | Value | Managed by |
|------|------|-------|------------|
| A | ddns.sjer.red | 97.126.85.52 | DDNS updater |
| AAAA | ddns.sjer.red | 2602:47:d4af:2300:... | DDNS updater |
| AAAA | ddns.sjer.red | 2602:ae:15ba:9d00:... | DDNS updater |
| CNAME | files.sjer.red | public.r2.dev | Manual |
| CNAME | fm1._domainkey.sjer.red | fm1.sjer.red.dkim.fmhosted.com | Manual |
| CNAME | fm2._domainkey.sjer.red | fm2.sjer.red.dkim.fmhosted.com | Manual |
| CNAME | fm3._domainkey.sjer.red | fm3.sjer.red.dkim.fmhosted.com | Manual |
| CNAME | mc.sjer.red | ddns.sjer.red | Manual* |
| CNAME | shuxin.sjer.red | ddns.sjer.red | Manual* |
| MX | rp.sjer.red | in1/in2-smtp.messagingengine.com | Manual |
| SRV | 9x FastMail autodiscovery | caldav/carddav/imap/pop3/submission | Manual |
| SRV | _minecraft._tcp.sjer.red | mc.sjer.red:30000 | Manual |
| SRV | _minecraft._tcp.shuxin.sjer.red | shuxin.sjer.red:30000 | Manual |
| TXT | _acme-challenge.influxdb.ts.zeus.sjer.red | Tailscale cert | Tailscale |
| TXT | _acme-challenge.syncthing.ts.zeus.sjer.red | Tailscale cert | Tailscale |
| TXT | _dmarc.sjer.red | v=DMARC1; p=quarantine... | Manual** |
| TXT | postal-isna7c._domainkey.sjer.red | Old DKIM key | Stale |
| TXT | rp.sjer.red | v=spf1 include:spf.messagingengine.com ~all | Manual** |

\* mc.sjer.red and shuxin.sjer.red: k8s defines these in `mc-router-dns` DNSEndpoint, but
external-dns has not created ownership records. Records exist from manual creation.

\** _dmarc.sjer.red and rp.sjer.red TXT: k8s defines these in `sjer-red-txt` DNSEndpoint,
but external-dns has not created ownership records. The rp.sjer.red CNAME conflict
(issue #1) may be suppressing the entire sync batch for this endpoint group.

#### shepherdjerred.com (20 unmanaged records)

| Type | Name | Value | Notes |
|------|------|-------|-------|
| CNAME | shepherdjerred.com | sjer.red | k8s defines, no ownership |
| CNAME | www.shepherdjerred.com | sjer.red | k8s defines, no ownership |
| CNAME | fm1._domainkey | fm1...dkim.fmhosted.com | k8s defines, no ownership |
| CNAME | fm2._domainkey | fm2...dkim.fmhosted.com | k8s defines, no ownership |
| CNAME | fm3._domainkey | fm3...dkim.fmhosted.com | k8s defines, no ownership |
| MX | shepherdjerred.com | FastMail (x2) | k8s defines, no ownership |
| MX | *.shepherdjerred.com | FastMail (x2) | k8s defines, no ownership |
| SRV | 9x FastMail autodiscovery | various | Intentionally manual (bug #5551) |
| TXT | shepherdjerred.com | SPF for FastMail | k8s defines, no ownership |

Only `_dmarc.shepherdjerred.com` has external-dns ownership in this entire zone.

#### ts-mc.net (12 unmanaged records)

| Type | Name | Value |
|------|------|-------|
| A | minecraft.ts-mc.net | 15.204.44.15 |
| CNAME | fm1._domainkey.ts-mc.net | fm1.ts-mc.net.dkim.fmhosted.com |
| CNAME | fm2._domainkey.ts-mc.net | fm2.ts-mc.net.dkim.fmhosted.com |
| CNAME | fm3._domainkey.ts-mc.net | fm3.ts-mc.net.dkim.fmhosted.com |
| CNAME | storage.ts-mc.net | public.r2.dev |
| CNAME | ts-mc.net | cfargotunnel |
| MX | ts-mc.net | FastMail (x2) |
| MX | *.ts-mc.net | FastMail (x2) |
| TXT | ts-mc.net | SPF for FastMail |

#### Remaining zones (all unmanaged records)

**better-skill-capped.com:** CNAME (apex), TXT (SPF), TXT (_dmarc), TXT (*._domainkey)
-- all 4 records are unmanaged despite k8s defining _dmarc and *._domainkey

**clauderon.com:** CNAME (apex), TXT (SPF) -- only these 2 are unmanaged

**discord-plays-pokemon.com:** CNAME (apex), TXT (SPF) -- only these 2 are unmanaged

**glitter-boys.com:** all 6 records unmanaged (3 CNAMEs, 3 TXTs)

**jerred.is:** CNAME (apex), CNAME (www), TXT (SPF) -- 3 unmanaged

**jerredshepherd.com:** all 5 records unmanaged (2 CNAMEs, 3 TXTs)

**scout-for-lol.com:** CNAME (apex), TXT (SPF) -- only these 2 are unmanaged

---

## external-dns Configuration

```
--policy=sync
--registry=txt
--txt-owner-id=homelab-external-dns
--txt-prefix=_externaldns.
--interval=1m
--source=service
--source=crd
--managed-record-types=A,AAAA,CNAME,SRV,TXT,MX
--provider=cloudflare
--cloudflare-proxied
```

Domain filters: all 10 zones are included.

Pod: `external-dns-69598f6d64-4djrj` Running, 6 restarts in 3d4h.

---

## Recommendations

### P0: Fix rp.sjer.red CNAME conflict

The `postal-return-path-dns` DNSEndpoint defines a CNAME for rp.sjer.red, but
`sjer-red-txt` defines TXT and `sjer-red-mx` defines MX for the same name.
external-dns discards the CNAME every cycle.

**Options:**
1. Remove the rp.sjer.red CNAME from `postal-return-path-dns` (Postal probably doesn't need it since MX handles mail delivery)
2. Split into separate DNSEndpoints so the CNAME is in its own resource (won't help -- external-dns merges all endpoints before conflict detection)
3. Use Cloudflare CNAME flattening: create the CNAME manually and remove from DNSEndpoint

### P0: Fix ts-mc.net DMARC drift

external-dns owns the record but hasn't updated it. Check if the ArgoCD app
for external-domains is synced. If it is, external-dns may need a restart.

### P1: Investigate why 3 zones have zero ownership

better-skill-capped.com, glitter-boys.com, and jerredshepherd.com have deployed
DNSEndpoints but external-dns hasn't created ownership records. Possible causes:
- Records were created manually before external-dns and it won't adopt them
- A previous sync error caused external-dns to skip these zones
- The `--policy=sync` with `--registry=txt` requires records to be initially
  absent for external-dns to create them with ownership

**Fix:** Delete the records manually, let external-dns recreate them with ownership.
Or for records that must exist continuously, temporarily switch to `--policy=upsert-only`.

### P1: Clean up stale records

Delete from Cloudflare:
- `CNAME` peertube.sjer.red + `_managed.peertube.sjer.red` TXT
- `CNAME` bugsink.shepherdjerred.com.sjer.red + `_managed.bugsink.shepherdjerred.com.sjer.red` TXT
- `TXT` postal-isna7c._domainkey.sjer.red (old DKIM key)
- `TXT` _externaldns.srv-_minecraft._tcp.ts-mc.net (stale ownership, no matching DNSEndpoint)

### P2: Bring more records under CDK8s management

Records that could be moved to DNSEndpoints:
- FastMail DKIM CNAMEs for sjer.red and ts-mc.net (fm1/fm2/fm3._domainkey)
- ts-mc.net email setup (MX, SPF, DKIM CNAMEs)
- R2 storage CNAMEs (files.sjer.red, storage.ts-mc.net)
- minecraft.ts-mc.net A record

Records that **cannot** be managed by external-dns:
- SRV records (bug #5551 -- though ts-mc.net SRV IS managed, so this may be partially fixed)
- DDNS A/AAAA records (managed by DDNS updater)
- Tailscale ACME challenge TXT records (managed by Tailscale)
- Apex CNAME + TXT combinations (Cloudflare API limitation)
